name: PocketMine Test Server Backup

on:
  workflow_dispatch:

jobs:
  test-server:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y unzip tar libyaml-0-2

    - name: Prepare server directory
      run: |
        mkdir server

    - name: Extract PHP binary (bin2.zip)
      run: |
        unzip bin2.zip -d server
        chmod +x server/bin/php7/bin/php

    - name: Extract PocketMine core (core.zip)
      run: |
        unzip core.zip -d server
        # Renombrar hpcore.phar a PocketMine-MP.phar
        if [ -f server/hpcore.phar ]; then
          mv server/hpcore.phar server/PocketMine-MP.phar
        fi

    - name: Copy start.sh
      run: |
        cp start.sh server/start.sh
        chmod +x server/start.sh

    - name: Fix permissions (Permission denied FIX)
      run: |
        chmod -R u+rwX server
        ls -l server/bin/php7/bin/php
        ls -l server/start.sh

    - name: Run PocketMine test server
      run: |
        cd server
        timeout 40s ./start.sh || true

    - name: Create full server backup
      run: |
        tar -czvf pocketmine-server-backup.tar.gz server/

    - name: Upload backup artifact
      uses: actions/upload-artifact@v4
      with:
        name: pocketmine-server-backup
        path: pocketmine-server-backup.tar.gz
